---
title: "中级SQL"
subtitle: "Database system concepts, cn 6e, ch. 4"
layout: post
author: "Chris"
header-style: text
tags:
- 笔记
- 数据库
---

# 4.1 连接表达式

```sql
SELECT *
FROM R1 JOIN R2 ON R1.id = R2.id;
```

- **外连接**

  - 总会出现某个表的所有行，*另一个表中无原始值的被填充为`null`*！(一定，即使有default)

  - `LEFT JOIN` / `RIGHT JOIN` / `FULL JOIN` / `CROSS JOIN 笛卡尔积`  // `NATURAL (L/R/F/C) JOIN`

    > OUTER JOIN 总是返回两个关系中所有**列**，但保证一个关系中的所有**行**全部出现
    >
    > NATURAL ? JOIN 在natural join的基础上

- **内连接** (默认关键字 INNER)：不保留未匹配元组(row)



# 4.2 VIEW

不是逻辑模型的一部分，作为***虚关系***对用户可见

```sql
CREATE VIEW v AS <query expr>;		-- () can be omitted
CREATE VIEW v (col_name1, col_name2) AS <expr>;		-- 显式指定属性名
```

- **物化视图**

  > 特定数据库系统支持存储视图关系，但保证随实际关系修改能更新视图关系

  ***updatebale*** := form single db, select has no expr/distinct/collaction...  `PSQL`更新视图是对实际关系的修改



## 4.3 事务 Transaction

- commit / rollback



## 4.4.1 Referential integrity

```sql
col_name <col_type> REFERENCES t(tar_col)
												ON DELETE <CASCADE / SET NULL / SET DEFAULT>
												ON UPDATE CASCADE,
-- columns...
```

若某外码列为null，则自动被认为满足约束



## 4.4.6 transaction中暂时性违法完整性约束

在声明约束时： `initially deferred`

需要时：`SET CONSTRAINTS c1 DEFERRED;` 但默认还是立即检查



#### 4.4.7 Assert

```sql
do $$
declare 
   film_count integer;
begin
   select count(*)
   into film_count
   from film;
   
   assert film_count > 0, 'Film not found';		-- !!!!
end$$;
```



# 4.5 其他数据类型

```sql
date '2021-07-06'
time '09:30:00'
timestamp '2021-07-06 09:30:15.00'
```

```sql
SELECT CAST('2021-09-24' AS date);
SELECT EXTRACT(MONTH FROM CAST('2021-09-24' AS date));
```

```sql
movie blob(2GB)		-- KB, MB...
-- 通常检索出的是大对象的“定位器”，在宿主语言中用“定位器”操作大对象
```

### ==4.5.3 Index==

```sql
CREATE INDEX index_sid ON student(id);		-- or on a list of columns
```

一般查询：读取每条记录并取出其中特定字段，低效

SQL查询处理器会在建立索引并有益时自动使用index



### ==**`Speed up!`**==

- index
- `on conflict do nothing`
- psycopg2.excute_values()
- initially deferred & set constraints c1 deferred;
- multiprocessing 宿主语言并行插入



### 4.5.5 用户自定类型

- structured data type (omitted here)
- distinct ==**type**==

```sql
CREATE TYPE name AS
    ( [ attribute_name data_type [ COLLATE collation ] [, ... ] ] );

CREATE TYPE name AS ENUM
    ( [ 'label' [, ... ] ] );
    
ALTER TYPE t RENAME ATTRIBUTE a TO aa;
DROP TYPE t;
```

- ==**domain**==

  > domain上可以声明constraints
  >
  > domain不是强类型的，只要两个domains的基本类型一致，可以相互传递赋值

  ```sql
  CREATE DOMAIN d AS numeric(3) NOT NULL CHECK (VALUE > 100); 
  ```

### 4.5.6 create table 拓展

`CREATE TABLE AS <query expr>`将查询结果放入新表，类似`CREATE VIEW`，但后者为虚关系，数据随原表更新



# 4.6 授权

```sql
GRANT/REVOKE <privilege list>
ON <relation / view>
TO <user / role>
```

标准权限：`select` `insert` `update` `delete`

`TO Public`：系统现在所有用户及将来的用户

### Role

权限可授给user/role，每个user有单独授给user的权限和所在role的所有权限

`sql security invoker`：函数限制在调用者的权限下执行(DBC, 6e, pp.83)

*`reference`* 权限：因为限制了其他用户将来的行为

## 权限的转移

默认下，被授权的用户无法把权限授予其他role，若允许转移：

```sql
grant select on dept to chris WITH GRANT OPTION;
```

## 收权

默认级联收权 (cascade)，**`restrict`防止级联，若存在任何需要级联，系统抛错，不收回任何权限**

```sql
revoke all privileges on dept FROM usr RESTRICT;
revoke grant option for select on dept from usr;		-- 仅收回grant option，不收权
```

role在会话中的权限   DBC, 6e, pp.84